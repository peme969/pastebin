<!doctype html>
<html lang="en" style="--dynamic-bg: #282c34; --dynamic-text: #ffa200">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="title" content="Peme969‚Äôs Pastebin" />
        <meta
            name="description"
            content="Peme969‚Äôs Personal Pastebin Email me for a temp key üîë"
        />
        <meta
            name="keywords"
            content="bio, personal pastebin, peme, cloudflare, cloudflare-pages, cloudflare-workers, pastebin"
        />
        <meta name="robots" content="index, follow" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="language" content="English" />
        <meta name="revisit-after" content="10 days" />
        <link rel="icon" type="image/x-icon" href="./favicon.ico" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="./apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="./favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="./favicon-16x16.png"
        />
        <link rel="manifest" href="./site.webmanifest" />
        <title>My Pastebin üåôüåå</title>
        <link rel="stylesheet" href="./style.css" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
        <div class="navbar">
            <select class="palette-dropdown" id="palette-selector">
                <option value="DarkSky">Dark Sky</option>
                <option value="DeepOcean">DeepOcean</option>
            </select>
            <h1>Peme969's Pastebin</h1>
        </div>
        <div class="container">
            <!-- TABS NAV -->
            <div class="tabs">
                <div class="tab active" data-target="#create-tab">
                    Create Paste
                </div>
                <div class="tab" data-target="#manage-tab">Manage Pastes</div>
            </div>

            <!-- CREATE PANEL -->
            <div id="create-tab" class="tab-content active">
                <form class="create-form">
                    <input
                        id="secret-input"
                        type="text"
                        placeholder="Secret Key"
                        required
                    />
                    <input
                        id="slug-input"
                        type="text"
                        placeholder="Slug (optional)"
                    />
                    <input
                        id="expiration-input"
                        type="text"
                        placeholder="YYYY-MM-DD hh:mm AM/PM (optional)"
                    />
                    <input
                        id="password-input"
                        type="password"
                        placeholder="Password (optional)"
                    />
                    <textarea
                        id="paste-content"
                        placeholder="Your paste here‚Ä¶"
                        required
                    ></textarea>
                    <input type="submit" id="create" value="Create Paste" />
                </form>
                <div class="result-container">
                    <h3 id="had">API Response:</h3>
                    <p id="result">Submit the form to create a paste...</p>
                </div>
            </div>

            <!-- MANAGE PANEL -->
            <div id="manage-tab" class="tab-content">
                <div class="manage-inputs">
                    <input
                        id="manage-secret"
                        type="text"
                        placeholder="Secret Key (optional)"
                    />
                    <button id="load-pastes" class="btn">Load My Pastes</button>
                </div>
                <table id="pastes-table">
                    <thead>
                        <tr>
                            <th>Paste Slug</th>
                            <th>Created</th>
                            <th>Expires At</th>
                            <th>Password</th>
                            <th>Content</th>
                            <th>View</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="manage-info" class="info-box">
                    Click ‚ÄúLoad My Pastes‚Äù to view and manage your pastes.
                </div>
            </div>
        </div>

        <script>
            // Theme logic (same as link shortener)
            const themeDict = {
                DarkSky: {
                    bg: "--palette1-bg",
                    text: "--palette1-text",
                    hover: "--palette3-text",
                    title: "My Pastebin üåôüåå",
                },
                DeepOcean: {
                    bg: "--palette3-bg",
                    text: "--palette3-text",
                    hover: "--palette1-text",
                    title: "My Pastebin üåä",
                },
            };
            function applyTheme(theme) {
                if (!themeDict[theme]) return;
                const root = document.documentElement;
                const def = themeDict[theme];
                root.style.setProperty(
                    "--dynamic-bg",
                    getComputedStyle(root).getPropertyValue(def.bg),
                );
                root.style.setProperty(
                    "--dynamic-text",
                    getComputedStyle(root).getPropertyValue(def.text),
                );
                root.style.setProperty(
                    "--hover-color",
                    getComputedStyle(root).getPropertyValue(def.hover),
                );
                document.body.style.background = "var(--dynamic-bg)";
                document.body.style.color = "var(--dynamic-text)";
                document.title = def.title;
                $("#palette-selector").val(theme);
                localStorage.setItem("theme", theme);
            }
            $(function () {
                const saved = localStorage.getItem("theme") || "DarkSky";
                applyTheme(saved);
                $("#palette-selector").on("change", function () {
                    applyTheme(this.value);
                });
            });

            // Tab switching
            $(".tab").click(function () {
                const target = $(this).data("target");
                $(".tab").removeClass("active");
                $(this).addClass("active");
                $(".tab-content").removeClass("active");
                $(target).addClass("active");
            });

            // Create paste (unchanged)
            (function () {
                const $btn = $("#create"),
                    $exp = $("#expiration-input"),
                    $res = $("#result");
                const expPattern = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2} (AM|PM)$/;
                function validate() {
                    const val = $exp.val().trim();
                    if (val && !expPattern.test(val)) {
                        $res.text(
                            "‚ö†Ô∏è Expiration must be YYYY-MM-DD hh:mm AM/PM",
                        )
                            .addClass("bad")
                            .removeClass("good");
                        $btn.prop("disabled", true);
                        return false;
                    }
                    $res.text("").removeClass("bad good");
                    $btn.prop("disabled", false);
                    return true;
                }
                $exp.on("input", validate);
                $(".create-form").submit(function (e) {
                    e.preventDefault();
                    if (!validate()) return;
                    const secret = $("#secret-input").val().trim();
                    const data = {
                        text: $("#paste-content").val(),
                        expiration: $exp.val().trim(),
                    };
                    if ($("#slug-input").val().trim())
                        data.slug = $("#slug-input").val().trim();
                    if ($("#password-input").val().trim())
                        data.password = $("#password-input").val().trim();
                    if (!secret) {
                        $res.text("‚ö†Ô∏è Secret Key required").addClass("bad");
                        return;
                    }
                    $res.removeClass("good bad").text("Creating paste‚Ä¶");
                    $.ajax({
                        url: "/api/create",
                        type: "POST",
                        headers: {
                            Authorization: "Bearer " + secret,
                            "Content-Type": "application/json",
                        },
                        data: JSON.stringify(data),
                        success(res) {
                            $res.html(
                                `‚úÖ Paste created!<br>Slug: <a href="/api/view/${res.slug}" target="_blank">${res.slug}</a><br>Expires: ${res.formattedExpiration}`,
                            ).addClass("good");
                        },
                        error(xhr) {
                            $res.text(
                                "Error: " +
                                    (xhr.responseJSON?.error || xhr.statusText),
                            ).addClass("bad");
                        },
                    });
                });
            })();

            // Manage pastes with content and view link
            function loadPastes() {
                const secret = $("#manage-secret").val().trim();
                const $tbody = $("#pastes-table tbody"),
                    $info = $("#manage-info");
                $tbody.empty();
                $info.text("Loading‚Ä¶");
                $.ajax({
                    url: "/api/pastes",
                    type: "GET",
                    headers: secret
                        ? { Authorization: "Bearer " + secret }
                        : {},
                    success(pastes) {
                        if (!pastes.length) {
                            $info.text("No pastes found.");
                            return;
                        }
                        pastes.forEach((p) => {
                            const created = p.created;
                            const expires = p.expiration || "‚Äî";
                            const password = p.password ? p.password : "";
                            // Fetch each paste's full content
                            $.ajax({
                                url: `/api/view/${p.slug}`,
                                type: "GET",
                                headers: password
                                    ? { "X-Paste-Password": password }
                                    : {},
                                success(record) {
                                    const content = record.text
                                        .replace(/</g, "&lt;")
                                        .replace(/>/g, "&gt;");
                                    const viewLink = `<a href="/api/view/${p.slug}" target="_blank">View</a>`;
                                    $tbody.append(`
                  <tr>
                    <td><a href="/api/view/${p.slug}" target="_blank">${p.slug}</a></td>
                    <td>${created}</td>
                    <td>${expires}</td>
                    <td>${password || "‚Äî"}</td>
                    <td><pre class="content-snippet">${content}</pre></td>
                    <td>${viewLink}</td>
                    <td><button class="btn delete" data-slug="${p.slug}">üóëÔ∏è</button></td>
                  </tr>
                `);
                                },
                                error() {
                                    // Could not fetch content
                                    $tbody.append(`
                  <tr>
                    <td><a href="/api/view/${p.slug}" target="_blank">${p.slug}</a></td>
                    <td>${created}</td>
                    <td>${expires}</td>
                    <td>${password || "‚Äî"}</td>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td><button class="btn delete" data-slug="${p.slug}">üóëÔ∏è</button></td>
                  </tr>
                `);
                                },
                            });
                        });
                        $info.text(`Loaded ${pastes.length} paste(s).`);
                    },
                    error() {
                        $info.text("Error loading pastes.");
                    },
                });
            }
            $("#load-pastes").click(loadPastes);

            // Delete paste
            $("#pastes-table").on("click", ".btn.delete", function () {
                const slug = $(this).data("slug");
                if (!confirm(`Delete paste ‚Äú${slug}‚Äù?`)) return;
                const secret = $("#manage-secret").val().trim();
                $.ajax({
                    url: "/api/delete",
                    type: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        ...(secret
                            ? { Authorization: "Bearer " + secret }
                            : {}),
                    },
                    data: JSON.stringify({ slug }),
                    success() {
                        loadPastes();
                    },
                    error() {
                        alert("Delete failed");
                    },
                });
            });
        </script>
    </body>
</html>
